{% include 'header.html' with context %}
<div class="container">
    {% include 'sidebar.html' with context %}

    <main class="content auth-page">
        <div class="auth-wrap">
            <div class="auth-card">
                <div class="auth-header">
                    <div class="auth-back">
                        <a class="auth-back-link" href="/settings" aria-label="Back to Settings">← Back to Settings</a>
                    </div>
                    <div class="auth-title">Sign in with Microsoft</div>
                </div>

                <div class="auth-section-title">Status</div>
                <div id="step1" class="auth-kv auth-status">
                    <div class="auth-row">
                        <div class="auth-label">Verification URL</div>
                        <div class="auth-value auth-link">
                            <span id="verification"></span>
                        </div>
                    </div>

                    <div class="auth-row">
                        <div class="auth-label">User code</div>
                        <div class="auth-value auth-code-row">
                            <code id="usercode">...</code>
                            <button class="auth-btn auth-btn--small" id="btnCopyCode" type="button">Copy code</button>
                        </div>
                    </div>

                    <div class="auth-row">
                        <div class="auth-label">Info</div>
                        <div class="auth-value auth-muted" id="expires"></div>
                    </div>
                </div>

                <div class="auth-actions auth-actions--spread">
                    <button class="auth-btn primary" id="btnPoll">Continue (poll)</button>
                    <div class="auth-actions-right">
                        <button class="auth-btn" id="btnEvents">Fetch events</button>
                        <button class="auth-btn" id="btnLogout">Sign out</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Toast/popup for JSON output -->
        <div id="authToast" class="auth-toast auth-toast--hidden" role="status" aria-live="polite" aria-atomic="true">
            <div class="auth-toast__header">
                <div class="auth-toast__title">Status</div>
                <button id="authToastClose" class="auth-toast__close" type="button" aria-label="Close">×</button>
            </div>
            <pre id="authToastBody" class="auth-toast__body"></pre>
        </div>

        <script>
            const verification = document.getElementById("verification");
            const usercode = document.getElementById("usercode");
            const expires = document.getElementById("expires");
            const btnPoll = document.getElementById("btnPoll");
            const btnLogout = document.getElementById("btnLogout");
            const btnEvents = document.getElementById("btnEvents");
            const btnCopyCode = document.getElementById("btnCopyCode");

            const authToast = document.getElementById("authToast");
            const authToastBody = document.getElementById("authToastBody");
            const authToastClose = document.getElementById("authToastClose");
            let authToastTimer = null;

            function show(obj) {
                const text = (typeof obj === "string") ? obj : JSON.stringify(obj, null, 2);
                if (authToastBody) authToastBody.textContent = text;
                if (authToast) {
                    authToast.classList.remove("auth-toast--hidden");
                    if (authToastTimer) clearTimeout(authToastTimer);
                    authToastTimer = setTimeout(() => {
                        authToast.classList.add("auth-toast--hidden");
                    }, 4500);
                }
            }

            if (authToastClose) {
                authToastClose.addEventListener("click", () => {
                    if (authToastTimer) clearTimeout(authToastTimer);
                    authToast.classList.add("auth-toast--hidden");
                });
            }

            // Start with logged-in actions hidden until we know auth state
            if (btnLogout) btnLogout.style.display = "none";
            if (btnEvents) btnEvents.style.display = "none";
            if (btnCopyCode) btnCopyCode.style.display = "none";

            async function copyUserCode() {
                const code = (usercode?.textContent || "").trim();
                if (!code || code === "..." || code === "-") return;

                try {
                    await navigator.clipboard.writeText(code);
                    show({ status: "copied", code_length: code.length });
                } catch {
                    const ta = document.createElement("textarea");
                    ta.value = code;
                    ta.style.position = "fixed";
                    ta.style.left = "-9999px";
                    document.body.appendChild(ta);
                    ta.select();
                    document.execCommand("copy");
                    document.body.removeChild(ta);
                    show({ status: "copied_fallback", code_length: code.length });
                }
            }

            async function startLogin() {
                show("Calling /api/auth_microsoft/login…");
                const r = await fetch("/api/auth_microsoft/login");
                const j = await r.json();

                if (j.status === "already_authenticated") {
                    verification.innerHTML = "<span class='ok'>Already signed in.</span>";
                    usercode.textContent = "-";
                    expires.textContent = "";

                    // Signed in: hide poll, show logout + fetch, hide copy
                    if (btnPoll) btnPoll.style.display = "none";
                    if (btnLogout) btnLogout.style.display = "";
                    if (btnEvents) btnEvents.style.display = "";
                    if (btnCopyCode) btnCopyCode.style.display = "none";

                    show(j);
                    return;
                }

                // Not signed in: show poll, hide logout + fetch, show copy only when code is present
                if (btnPoll) btnPoll.style.display = "";
                if (btnLogout) btnLogout.style.display = "none";
                if (btnEvents) btnEvents.style.display = "none";

                if (!j.verification_uri || !j.user_code) {
                    verification.innerHTML = "<span class='err'>Missing verification data.</span>";
                    show(j);
                    return;
                }

                verification.innerHTML = `<a href="${j.verification_uri}" target="_blank" rel="noopener noreferrer">${j.verification_uri}</a>`;
                usercode.textContent = j.user_code;
                if (btnCopyCode) btnCopyCode.style.display = j.user_code ? "" : "none";

                if (j.expires_in) {
                    expires.textContent = `Code valid for about: ${j.expires_in}s (poll every ~${j.interval ?? 5}s).`;
                } else {
                    expires.textContent = "";
                }

                show(j);
            }

            async function poll() {
                show("Calling /api/auth_microsoft/poll…");
                const r = await fetch("/api/auth_microsoft/poll");
                const j = await r.json().catch(() => ({ error: "Invalid JSON response." }));
                show(j);

                if (r.ok && j.status === "authenticated") {
                    // Automatically fetch events after successful authentication
                    await fetchEvents();
                    // Refresh page to reflect signed-in state (and hide poll)
                    location.reload();
                }
            }

            async function logout() {
                show("Calling /api/auth_microsoft/logout…");
                const r = await fetch("/api/auth_microsoft/logout");
                const j = await r.json();
                show(j);
                if (r.ok) {
                    // Refresh page to return to initial state
                    location.reload();
                }
            }

            async function fetchEvents() {
                show("Calling /api/auth_microsoft/events…");
                const r = await fetch("/api/auth_microsoft/events");
                let j;
                try {
                    j = await r.json();
                } catch {
                    j = {error: "Invalid response from /api/auth_microsoft/events."};
                }
                show(j);
            }

            document.getElementById("btnPoll").addEventListener("click", poll);
            document.getElementById("btnLogout").addEventListener("click", logout);
            document.getElementById("btnEvents").addEventListener("click", fetchEvents);
            if (btnCopyCode) btnCopyCode.addEventListener("click", copyUserCode);

            // auto-start
            startLogin().catch(e => show({error: String(e)}));
        </script>
    </main>
</div>
</body>
</html>
